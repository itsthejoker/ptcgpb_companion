{% extends "base.html" %}

{% block title %}Card Counter - All Cards{% endblock %}

{% block content %}
    <style>
        /* Accordion styling */
        details.accordion {
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 0.5rem;
            padding: 0.5rem;
        }
        
        details.accordion summary {
            cursor: pointer;
            font-weight: 600;
            padding: 0.5rem;
            border-radius: 4px;
            background-color: #f0f0f0;
            transition: background-color 0.2s;
        }
        
        details.accordion summary:hover {
            background-color: #e0e0e0;
        }
        
        details.accordion[open] summary {
            background-color: #e8e8e8;
        }
        
        .accordion-content {
            margin-top: 0.5rem;
            padding: 0.5rem;
        }
        
        .instance {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: #f9f9f9;
            border-radius: 4px;
            border-left: 3px solid #ddd;
        }
        
        /* Modal styling */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            overflow: auto;
        }
        
        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            position: relative;
            top: 50%;
            transform: translateY(-50%);
            animation: zoom 0.3s;
        }
        
        .modal-info {
            text-align: center;
            color: white;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
            background-color: rgba(0, 0, 0, 0.7);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        
        .modal-close:hover,
        .modal-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
        
        .modal-navigation {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        
        .modal-navigation:hover {
            opacity: 1;
        }
        
        .modal-prev {
            left: 15px;
        }
        
        .modal-next {
            right: 15px;
        }
        
        @keyframes zoom {
            from {transform: scale(0.8); opacity: 0;}
            to {transform: scale(1); opacity: 1;}
        }
        
        /* Make card images clickable */
        .card-image-clickable {
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .card-image-clickable:hover {
            transform: scale(1.02);
        }
        
        /* Multi-select styling */
        select[multiple] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: white;
            overflow-y: auto;
        }
        
        select[multiple]:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        select[multiple] option:checked {
            background-color: var(--primary);
            color: white;
        }
        
        select[multiple]:disabled {
            background-color: var(--secondary-bg);
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        /* Rarity filter checkbox styling */
        #all_rarities {
            margin-right: 0.5rem;
        }
    </style>
    
    <article>
        <!-- Image Modal -->
        <div id="imageModal" class="image-modal">
            <span class="modal-close">&times;</span>
            <span class="modal-navigation modal-prev">&#10094;</span>
            <span class="modal-navigation modal-next">&#10095;</span>
            <img class="modal-content" id="modalImage" alt="Card Image">
            <div class="modal-info" id="modalInfo"></div>
        </div>
        
        <header>
            <h2>All Cards Index</h2>
            <p>Browse all cards found in screenshots, organized by account</p>
        </header>
        
        <section>
            <h3>Filter Cards</h3>
            <form method="get" action="{{ url_for('cards') }}" class="grid">
                <div>
                    <label for="account_filter">Account Filter</label>
                    <select name="account_filter" id="account_filter">
                        <option value="">All Accounts</option>
                        {% for account in accounts %}
                        <option value="{{ account }}" {% if account == current_account %}selected{% endif %}>{{ account }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="set_filter">Set Filter</label>
                    <select name="set_filter" id="set_filter">
                        <option value="">All Sets</option>
                        {% for set_obj in sets %}
                        <option value="{{ set_obj.raw_name }}" {% if set_obj.raw_name == current_set %}selected{% endif %}>{{ set_obj.display_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="search">Card Name Search</label>
                    <input type="text" name="search" id="search" value="{{ search_query }}" placeholder="Search card names...">
                </div>
                
                <div>
                    <label>Rarity Filter</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="all_rarities" {% if not current_rarities or current_rarities|length == 0 %}checked{% endif %}>
                            <span>All Rarities</span>
                        </label>
                    </div>
                    <select name="rarity_filter" id="rarity_filter" multiple size="4" {% if not current_rarities or current_rarities|length == 0 %}disabled{% endif %}>
                        {% for rarity in rarities %}
                        <option value="{{ rarity }}" {% if rarity in current_rarities %}selected{% endif %}>{{ rarity }}</option>
                        {% endfor %}
                    </select>
                    <small>Hold Ctrl/Cmd to select multiple rarities, or check "All Rarities" to show all.</small>
                </div>
                
                <button type="submit" class="contrast">Filter Cards</button>
            </form>
        </section>
        
        {% if grouped_cards %}
        <section>
            <h3>Results</h3>
            <p>Showing {{ grouped_cards|length }} unique cards{{ ' for account: ' + current_account if current_account }} {{ ' from set: ' + current_set if current_set }}</p>
            
            <div class="card-grid">
                {% for card in grouped_cards %}
                <div class="card">
                    <h4>{{ card.display_card_name }}</h4>
                    <p><strong>Set:</strong> {{ card.display_set_name }}</p>
                    {% if card.rarity %}
                    <p><strong>Rarity:</strong> {{ card.rarity }}</p>
                    {% endif %}
                    
                    {% if card.instances|length > 1 %}
                    <details class="accordion">
                        <summary>View {{ card.instances|length }} instances</summary>
                        <div class="accordion-content">
                            {% for instance in card.instances %}
                            <div class="instance" style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
                                <p><strong>Account:</strong> {{ instance.account }}</p>
                                <p><strong>Screenshot:</strong> {{ instance.actual_filename }}</p>
                                <p><strong>Position:</strong> {{ instance.position }}</p>
                                <p><strong>Confidence:</strong> {{ "%.1f"|format(instance.confidence * 100) }}%</p>
                            </div>
                            {% endfor %}
                        </div>
                    </details>
                    {% else %}
                    <div style="margin-top: 0.5rem;">
                        <p><strong>Account:</strong> {{ card.instances[0].account }}</p>
                        <p><strong>Screenshot:</strong> {{ card.instances[0].actual_filename }}</p>
                    </div>
                    {% endif %}
                    
                    {% if card.card_set and card.card_name %}
                    <div style="margin-top: 1rem;">
                        <img src="/static/card_imgs/{{ card.card_set }}/{{ card.image_card_name }}.webp"
                             alt="{{ card.display_card_name }}"
                             loading="lazy"
                             style="width: 100%; max-width: 200px; height: auto; border-radius: 8px;"
                             class="card-image-clickable"
                             data-card-index="{{ loop.index0 }}"
                             data-card-name="{{ card.display_card_name }}"
                             data-card-set="{{ card.card_set }}"
                             data-image-name="{{ card.image_card_name }}"
                             onerror="this.onerror=null; this.src='data:image/svg+xml;charset=utf-8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22279%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23ccc%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23666%22 font-family=%22Arial%22 font-size=%2212%22>{{ card.display_card_name }}</text></svg>'">
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </section>
        {% else %}
        <section>
            <div class="card">
                <p>No cards found matching the current filters.</p>
                <p>Try adjusting your search criteria or processing some screenshots first.</p>
            </div>
        </section>
        {% endif %}
        
        <div class="grid">
            <a href="{{ url_for('index') }}" class="outline" style="justify-self: start;">
                ‚Üê Back to Main Page
            </a>
        </div>
    </article>
    
    <script>
        // Rarity filter functionality
        document.addEventListener('DOMContentLoaded', function() {
            const allRaritiesCheckbox = document.getElementById('all_rarities');
            const raritySelect = document.getElementById('rarity_filter');
            
            if (allRaritiesCheckbox && raritySelect) {
                // Toggle select box based on checkbox
                allRaritiesCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        raritySelect.disabled = true;
                        // Clear all selections
                        for (let i = 0; i < raritySelect.options.length; i++) {
                            raritySelect.options[i].selected = false;
                        }
                    } else {
                        raritySelect.disabled = false;
                    }
                });
                
                // If any options are selected, uncheck the "All Rarities" box
                raritySelect.addEventListener('change', function() {
                    if (Array.from(this.selectedOptions).length > 0) {
                        allRaritiesCheckbox.checked = false;
                    }
                });
            }
        });
        
        // Modal functionality
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        const modalInfo = document.getElementById('modalInfo');
        const closeBtn = document.querySelector('.modal-close');
        const prevBtn = document.querySelector('.modal-prev');
        const nextBtn = document.querySelector('.modal-next');
        
        let currentIndex = 0;
        let cardImages = [];
        
        // Initialize card images array when page loads
        document.addEventListener('DOMContentLoaded', function() {
            cardImages = Array.from(document.querySelectorAll('.card-image-clickable'));
            
            // Add click event to each card image
            cardImages.forEach((img, index) => {
                img.addEventListener('click', function() {
                    openModal(index);
                });
            });
            
            // Close modal when clicking the close button
            closeBtn.addEventListener('click', closeModal);
            
            // Close modal when clicking outside the image
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            });
            
            // Navigation buttons
            prevBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                navigateModal(-1);
            });
            
            nextBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                navigateModal(1);
            });
            
            // Keyboard navigation
            document.addEventListener('keydown', function(event) {
                if (modal.style.display === 'block') {
                    if (event.key === 'Escape') {
                        closeModal();
                    } else if (event.key === 'ArrowLeft') {
                        navigateModal(-1);
                    } else if (event.key === 'ArrowRight') {
                        navigateModal(1);
                    }
                }
            });
        });
        
        function openModal(index) {
            if (index < 0 || index >= cardImages.length) return;
            
            currentIndex = index;
            const img = cardImages[currentIndex];
            
            // Set modal content
            modalImg.src = img.src;
            modalImg.alt = img.alt;
            modalInfo.textContent = img.dataset.cardName;
            
            // Show modal
            modal.style.display = 'block';
            
            // Update navigation button visibility
            updateNavigationButtons();
        }
        
        function closeModal() {
            modal.style.display = 'none';
        }
        
        function navigateModal(direction) {
            const newIndex = currentIndex + direction;
            
            if (newIndex >= 0 && newIndex < cardImages.length) {
                openModal(newIndex);
            }
        }
        
        function updateNavigationButtons() {
            // Navigation buttons are always visible, but we could add logic here
            // to disable them at boundaries if desired
        }
    </script>
{% endblock %}
